# 用户行为 API

本文档包含所有与用户行为相关的 API 接口，包括行为记录、统计数据和题目管理等功能。

## 1. 记录用户行为

**接口地址**: `POST /user-actions`

**接口描述**: 记录用户的操作行为，包括收藏和删除等

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |
| questionId | string | body | 是 | 题目 ID |
| action | string | body | 是 | 行为类型：favorited、deleted |

**请求示例**:

```
POST http://localhost:3000/user-actions
Content-Type: application/json

{
  "userId": "user123",
  "questionId": "64f1a2b3c4d5e6f789012346",
  "action": "favorited"
}
```

**响应示例**:

```json
{
  "success": true,
  "data": null,
  "message": "记录成功"
}
```

**错误响应**:

```json
{
  "success": false,
  "data": null,
  "message": "无效的行为类型，支持的行为类型：favorited、deleted"
}
```

或

```json
{
  "success": false,
  "data": null,
  "message": "缺少必要参数"
}
```

## 2. 获取用户统计数据

**接口地址**: `GET /user-actions/stats`

**接口描述**: 获取指定用户的答题统计信息

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | query | 否 | 用户 ID，默认为 "guest" |

**请求示例**:

```
# 获取默认用户统计
GET http://localhost:3000/user-actions/stats

# 获取指定用户统计
GET http://localhost:3000/user-actions/stats?userId=user123
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "favorited": 15,
    "deleted": 8,
    "total": 23
  },
  "message": "操作成功"
}
```

**字段说明**:

- `favorited`: 用户收藏的题目总数
- `deleted`: 用户删除的题目总数
- `total`: 总行为记录数

## 3. 重置用户删除的题目记录 (开发专用)

**接口地址**: `POST /user-actions/reset-deleted`

**接口描述**: 重置指定用户删除的题目记录，仅在开发环境中可用

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |

**请求示例**:

```
# 重置默认用户删除的题目记录
POST http://localhost:3000/user-actions/reset-deleted
Content-Type: application/json

{}

# 重置指定用户删除的题目记录
POST http://localhost:3000/user-actions/reset-deleted
Content-Type: application/json

{
  "userId": "user123"
}
```

**响应示例**:

```json
{
  "success": true,
  "data": null,
  "message": "成功重置 5 条删除记录"
}
```

**错误响应**:

```json
{
  "success": false,
  "data": null,
  "message": "Forbidden: Development endpoint only"
}
```

## 4. 恢复用户删除的题目

**接口地址**: `POST /user-actions/undelete`

**接口描述**: 恢复用户删除的题目，支持单个或批量恢复

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |
| questionIds | string/array | body | 是 | 要恢复的题目 ID 或 ID 数组 |

**请求示例**:

```
# 恢复单个题目
POST http://localhost:3000/user-actions/undelete
Content-Type: application/json

{
  "userId": "user123",
  "questionIds": "64f1a2b3c4d5e6f789012346"
}

# 批量恢复题目
POST http://localhost:3000/user-actions/undelete
Content-Type: application/json

{
  "userId": "user123",
  "questionIds": [
    "64f1a2b3c4d5e6f789012346",
    "64f1a2b3c4d5e6f789012347",
    "64f1a2b3c4d5e6f789012348"
  ]
}
```

**响应示例**:

```json
{
  "success": true,
  "data": null,
  "message": "成功恢复 3 道题目"
}
```

**错误响应**:

```json
{
  "success": false,
  "data": null,
  "message": "缺少必要参数: questionIds"
}
```

## 5. 获取用户删除的题目列表

**接口地址**: `POST /user-actions/deleted-questions`

**接口描述**: 获取用户删除的题目列表，支持分页

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |
| page | number | body | 否 | 页码，默认 1 |
| limit | number | body | 否 | 每页数量，默认 20 |

**请求示例**:

```
# 获取默认用户删除的题目列表
POST http://localhost:3000/user-actions/deleted-questions
Content-Type: application/json

{}

# 获取指定用户删除的题目列表
POST http://localhost:3000/user-actions/deleted-questions
Content-Type: application/json

{
  "userId": "user123",
  "page": 1,
  "limit": 10
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "questions": [
      {
        "_id": "64f1a2b3c4d5e6f789012349",
        "userId": "user123",
        "questionId": "64f1a2b3c4d5e6f789012346",
        "action": "deleted",
        "createdAt": "2023-09-01T10:00:00.000Z",
        "questionDetails": {
          "_id": "64f1a2b3c4d5e6f789012346",
          "id": "285acd89-b79b-49e6-8425-5d60d5101233",
          "type": "choice",
          "difficulty": "easy",
          "tags": ["vue", "lifecycle"],
          "question_markdown": "Vue 2.x 生命周期有哪些？分别做了什么？",
          "answer_simple_markdown": "beforeCreate → created → beforeMount → mounted...",
          "subjectId": "64f1a2b3c4d5e6f789012345"
        }
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 15,
      "totalPages": 1,
      "hasNext": false,
      "hasPrev": false
    }
  },
  "message": "操作成功"
}
```

## 6. 记录用户选择的科目

**接口地址**: `POST /user-actions/select-subject`

**接口描述**: 记录用户选择的科目，支持用户切换科目时更新记录

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |
| subjectId | string | body | 是 | 科目 ID |

**请求示例**:

```
# 记录默认用户选择的科目
POST http://localhost:3000/user-actions/select-subject
Content-Type: application/json

{
  "subjectId": "64f1a2b3c4d5e6f789012345"
}

# 记录指定用户选择的科目
POST http://localhost:3000/user-actions/select-subject
Content-Type: application/json

{
  "userId": "user123",
  "subjectId": "64f1a2b3c4d5e6f789012345"
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "userId": "user123",
    "subjectId": "64f1a2b3c4d5e6f789012345",
    "subjectName": "前端开发面试"
  },
  "message": "科目选择记录更新成功"
}
```

**错误响应**:

```json
{ "success": false, "data": null, "message": "缺少必要参数: subjectId" }
```

或

```json
{ "success": false, "data": null, "message": "科目不存在" }
```

## 7. 获取用户当前选择的科目

**接口地址**: `GET /user-actions/current-subject`

**接口描述**: 获取用户当前选择的科目，如果没有选择记录则返回默认科目

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | query | 否 | 用户 ID，默认为 "guest" |

**请求示例**:

```
# 获取默认用户当前选择的科目
GET http://localhost:3000/user-actions/current-subject

# 获取指定用户当前选择的科目
GET http://localhost:3000/user-actions/current-subject?userId=user123
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "_id": "64f1a2b3c4d5e6f789012345",
    "name": "前端开发面试",
    "code": "FE_INTERVIEW",
    "description": "涵盖 JS、CSS、Vue、React 等",
    "tags": [
      { "name": "JavaScript", "value": "javascript" },
      { "name": "CSS", "value": "css" },
      { "name": "React", "value": "react" },
      { "name": "Vue", "value": "vue" },
      { "name": "工程化", "value": "engineering" }
    ],
    "userTags": [],
    "difficultyLevels": [
      { "name": "简单", "value": "easy" },
      { "name": "中等", "value": "medium" },
      { "name": "困难", "value": "hard" }
    ],
    "isEnabled": true,
    "createdAt": "2023-09-01T00:00:00.000Z",
    "updatedAt": "2023-09-01T00:00:00.000Z"
  },
  "message": "操作成功"
}
```

**字段说明**:

- 返回科目对象包含所有科目相关信息，与 `/subjects` 接口返回的科目格式一致
- 如果用户没有选择科目记录，将返回第一个启用的默认科目
- 如果没有启用的科目，将返回 `null`

## 8. 设置音频播放偏好

**接口地址**: `POST /user-actions/set-audio-preferences`

**接口描述**: 设置用户的音频播放偏好，包括播放内容选择、播放速度和循环方式等

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | body | 否 | 用户 ID，默认为 "guest" |
| contentTypes | array | body | 否 | 播放内容类型，包含 question(题目)、answer(答案)、explanation(解析) |
| playbackSpeed | number | body | 否 | 播放速度，范围 0.5-3.0，默认 1.0 |
| loopMode | string | body | 否 | 循环方式，可选：none(不循环)、single(单曲循环)、all(全部循环) |
| loopCount | number | body | 否 | 循环次数，当 loopMode 不为 none 时有效，默认 1 |

**请求示例**:

```
POST http://localhost:3000/user-actions/set-audio-preferences
Content-Type: application/json

{
  "userId": "user123",
  "contentTypes": ["question", "answer"],
  "playbackSpeed": 1.25,
  "loopMode": "single",
  "loopCount": 2
}
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "userId": "user123",
    "contentTypes": ["question", "answer"],
    "playbackSpeed": 1.25,
    "loopMode": "single",
    "loopCount": 2,
    "updatedAt": "2023-11-06T10:30:00.000Z"
  },
  "message": "音频播放偏好设置成功"
}
```

**错误响应**:

```json
{
  "success": false,
  "data": null,
  "message": "无效的循环方式，支持的循环方式：none、single、all"
}
```

或

```json
{
  "success": false,
  "data": null,
  "message": "播放速度必须在0.5-3.0之间"
}

## 9. 获取音频播放偏好

**接口地址**: `GET /user-actions/audio-preferences`

**接口描述**: 获取用户的音频播放偏好设置

**请求参数**:
| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| userId | string | query | 否 | 用户 ID，默认为 "guest" |

**请求示例**:

```

# 获取默认用户的音频播放偏好

GET http://localhost:3000/user-actions/audio-preferences

# 获取指定用户的音频播放偏好

GET http://localhost:3000/user-actions/audio-preferences?userId=user123

````

**响应示例**:

```json
{
  "success": true,
  "data": {
    "userId": "user123",
    "contentTypes": ["question", "answer", "explanation"],
    "playbackSpeed": 1.0,
    "loopMode": "none",
    "loopCount": 1
  },
  "message": "获取成功"
}
````

**字段说明**:

- 如果用户没有设置过音频偏好，将返回默认设置（所有内容类型、1.0 倍速、不循环、循环次数 1）
- 返回的 `contentTypes` 默认包含所有三种类型：question、answer 和 explanation
- 返回的 `playbackSpeed` 默认值为 1.0
- 返回的 `loopMode` 默认值为 "none"
- 返回的 `loopCount` 默认值为 1
