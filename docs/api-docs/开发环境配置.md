# 开发环境配置

本文档提供刷题应用服务器端的开发环境配置指南，包括服务启动、数据库初始化、环境变量配置等内容。

## 1. 系统要求

在开始配置开发环境之前，请确保您的系统满足以下要求：

- **操作系统**：Windows、macOS 或 Linux
- **Node.js**：版本 14.0 或更高
- **npm**：版本 6.0 或更高
- **MongoDB**：版本 4.0 或更高
- **Git**：版本 2.0 或更高

## 2. 安装与设置

### 2.1 克隆仓库

首先，将代码仓库克隆到本地：

```bash
# 使用 HTTPS 克隆
https://github.com/your-username/shuati-app-server.git

# 或者使用 SSH 克隆
git@github.com:your-username/shuati-app-server.git

# 进入项目目录
cd shuati-app-server
```

### 2.2 安装依赖

使用 npm 安装项目依赖：

```bash
npm install
```

### 2.3 配置环境变量

在项目根目录创建 `.env` 文件，并根据需要配置以下环境变量：

```env
# 服务器配置
PORT=3000
HOST=localhost
NODE_ENV=development

# MongoDB 配置
MONGO_URI=mongodb://localhost:27017/shuati-app
MONGO_URI_TEST=mongodb://localhost:27017/shuati-app-test

# JWT 配置
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=24h

# 日志配置
LOG_LEVEL=debug
LOG_DIR=./logs

# 邮件服务配置（可选，用于用户验证和密码重置）
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_USER=your-email@example.com
EMAIL_PASS=your-email-password
EMAIL_FROM=your-email@example.com

# API 速率限制
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW_MS=60000

# 是否允许跨域请求
CORS_ALLOWED_ORIGINS=http://localhost:3001,http://localhost:3002
```

请根据您的实际环境修改上述配置值。

## 3. 数据库初始化

### 3.1 安装 MongoDB

如果您的系统上尚未安装 MongoDB，请按照 [MongoDB 官方文档](https://docs.mongodb.com/manual/installation/) 进行安装。

### 3.2 启动 MongoDB 服务

安装完成后，启动 MongoDB 服务：

**Windows**：

```cmd
net start MongoDB
```

**macOS**（使用 Homebrew 安装）：

```bash
brew services start mongodb-community
```

**Linux**：

```bash
sudo systemctl start mongod
```

### 3.3 初始化数据库

运行以下命令初始化数据库，创建必要的集合和索引：

```bash
npm run db:init
```

### 3.4 导入示例数据

如果需要导入示例数据进行开发和测试，可以运行以下命令：

```bash
npm run db:seed
```

此命令会导入一些示例科目、题目和用户数据。

## 4. 启动开发服务器

### 4.1 开发模式

在开发模式下启动服务器，代码变更会自动重启服务：

```bash
npm run dev
```

服务启动后，API 端点可通过 `http://localhost:3000` 访问。

### 4.2 生产模式

在生产环境中，使用以下命令启动服务器：

```bash
# 首先构建项目
npm run build

# 然后启动生产服务器
npm start
```

### 4.3 运行测试

运行单元测试和集成测试：

```bash
npm test
```

生成测试覆盖率报告：

```bash
npm run test:coverage
```

## 5. API 文档

开发服务器启动后，您可以访问以下地址查看 API 文档：

- Swagger UI: `http://localhost:3000/api-docs`
- Redoc: `http://localhost:3000/redoc`

## 6. 代码规范

项目使用 ESLint 和 Prettier 进行代码风格检查和格式化：

```bash
# 检查代码风格
npm run lint

# 自动修复代码风格问题
npm run lint:fix

# 格式化代码
npm run format
```

## 7. 常见问题与解决方案

### 7.1 MongoDB 连接失败

**问题**：无法连接到 MongoDB 数据库

**解决方案**：

- 确认 MongoDB 服务已启动
- 检查 `.env` 文件中的 `MONGO_URI` 配置是否正确
- 确认 MongoDB 用户权限设置正确

### 7.2 端口被占用

**问题**：启动服务器时提示端口已被占用

**解决方案**：

- 在 `.env` 文件中修改 `PORT` 配置，使用其他可用端口
- 或者终止占用该端口的进程

### 7.3 跨域请求被阻止

**问题**：前端应用无法向 API 发送请求，提示跨域错误

**解决方案**：

- 在 `.env` 文件中修改 `CORS_ALLOWED_ORIGINS` 配置，添加前端应用的域名

### 7.4 权限不足

**问题**：访问某些 API 端点时提示权限不足

**解决方案**：

- 确认用户已登录并持有有效的 JWT 令牌
- 检查用户角色是否具有足够的权限

## 8. 开发工作流

### 8.1 分支管理

- `main`：主分支，包含生产环境代码
- `develop`：开发分支，新功能在合并到主分支前先合并到此分支
- `feature/xxx`：功能分支，用于开发新功能
- `fix/xxx`：修复分支，用于修复 bug

### 8.2 提交规范

提交消息请遵循以下格式：

```
<type>: <description>

<body>

<footer>
```

其中 `<type>` 可以是以下值：

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档变更
- `style`: 不影响代码功能的样式变更
- `refactor`: 既不是修复 bug 也不是添加新功能的代码变更
- `perf`: 性能优化
- `test`: 添加或修改测试
- `chore`: 构建过程或辅助工具的变更

## 9. 部署指南

### 9.1 Docker 部署

项目包含 Dockerfile 和 docker-compose.yml 文件，可以使用 Docker 快速部署：

```bash
docker-compose up -d
```

### 9.2 持续集成/持续部署 (CI/CD)

项目支持 GitHub Actions 进行 CI/CD，配置文件位于 `.github/workflows` 目录下。推送代码到 GitHub 仓库时，会自动运行测试和构建流程。
