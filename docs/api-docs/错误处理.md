# 错误处理

本文档详细说明刷题应用 API 中的错误处理机制、统一错误响应格式、常见错误信息和 HTTP 状态码的使用。

## 1. 统一错误响应格式

API 的所有错误响应都遵循统一的 JSON 格式，方便客户端进行统一处理：

```json
{
  "success": false,
  "data": null,
  "message": "错误信息描述"
}
```

**字段说明**:

- `success`: 固定为 `false`，表示请求失败
- `data`: 固定为 `null`，错误响应不包含业务数据
- `message`: 错误信息描述，清晰说明错误原因

## 2. HTTP 状态码

API 使用标准的 HTTP 状态码来表示请求的处理结果。以下是常用状态码的说明：

| HTTP 状态码 | 说明                                   | 示例场景                                |
| ----------- | -------------------------------------- | --------------------------------------- |
| 200         | OK - 请求成功                          | 所有成功的 GET/POST/PUT/DELETE 请求     |
| 400         | Bad Request - 请求参数错误             | 参数缺失、参数格式错误、参数值不合法    |
| 401         | Unauthorized - 未授权                  | 用户未登录、登录状态过期、访问令牌无效  |
| 403         | Forbidden - 禁止访问                   | 用户权限不足、访问受限制的资源          |
| 404         | Not Found - 资源不存在                 | 请求的 API 端点不存在、请求的资源不存在 |
| 405         | Method Not Allowed - 方法不允许        | 使用了不支持的 HTTP 方法                |
| 422         | Unprocessable Entity - 无法处理的实体  | 请求格式正确但语义错误（如重复提交）    |
| 500         | Internal Server Error - 服务器内部错误 | 服务器处理过程中发生未知错误            |
| 503         | Service Unavailable - 服务不可用       | 服务器暂时无法处理请求（如过载）        |

## 3. 常见错误信息

以下是 API 中常见的错误信息，按照错误类型进行分类：

### 3.1 请求参数错误

| 错误信息                                             | 说明                   | HTTP 状态码 |
| ---------------------------------------------------- | ---------------------- | ----------- |
| 缺少必要参数: {paramName}                            | 请求中缺少必要的参数   | 400         |
| 参数类型错误: {paramName} 必须是 {expectedType} 类型 | 参数类型不符合要求     | 400         |
| 参数值不合法: {paramName}                            | 参数值不在允许的范围内 | 400         |
| 无效的参数格式: {paramName}                          | 参数格式不符合规范     | 400         |

### 3.2 资源不存在

| 错误信息   | 说明                         | HTTP 状态码 |
| ---------- | ---------------------------- | ----------- |
| 科目不存在 | 请求的科目 ID 不存在或已删除 | 404         |
| 题目不存在 | 请求的题目 ID 不存在或已删除 | 404         |
| 用户不存在 | 请求的用户 ID 不存在         | 404         |
| 标签不存在 | 请求的标签不存在             | 404         |

### 3.3 授权与认证错误

| 错误信息                             | 说明                             | HTTP 状态码 |
| ------------------------------------ | -------------------------------- | ----------- |
| 未授权访问                           | 用户未登录或登录状态过期         | 401         |
| 无效的令牌                           | 访问令牌格式错误或已失效         | 401         |
| 权限不足                             | 用户没有足够的权限执行操作       | 403         |
| Forbidden: Development endpoint only | 开发环境专用接口，生产环境不可用 | 403         |

### 3.4 业务逻辑错误

| 错误信息                                           | 说明                           | HTTP 状态码 |
| -------------------------------------------------- | ------------------------------ | ----------- |
| 无效的行为类型，支持的行为类型：favorited、deleted | 用户行为类型不支持             | 400         |
| 该题目已被收藏                                     | 用户尝试收藏已收藏的题目       | 400         |
| 该题目未被收藏                                     | 用户尝试取消收藏未收藏的题目   | 400         |
| 用户名或密码错误                                   | 用户登录凭证不正确             | 401         |
| 该邮箱已被注册                                     | 尝试使用已注册的邮箱注册新用户 | 400         |
| 验证码错误或已过期                                 | 用户提供的验证码不正确或已过期 | 400         |

### 3.5 服务器错误

| 错误信息                   | 说明                         | HTTP 状态码 |
| -------------------------- | ---------------------------- | ----------- |
| 服务器内部错误             | 服务器处理请求时发生未知错误 | 500         |
| 数据库连接失败             | 无法连接到数据库             | 500         |
| 服务暂时不可用，请稍后重试 | 服务器负载过高或维护中       | 503         |

## 4. 客户端错误处理建议

客户端在处理 API 错误时，建议遵循以下最佳实践：

1. **统一的错误处理机制**：实现一个统一的错误处理函数或中间件，处理所有 API 调用返回的错误

2. **区分 HTTP 状态码**：根据不同的 HTTP 状态码采取不同的处理策略：

   - 400 错误：检查请求参数，提示用户修正
   - 401 错误：引导用户重新登录
   - 403 错误：提示用户权限不足
   - 404 错误：提示用户资源不存在
   - 500 错误：提示用户服务器内部错误，建议稍后重试

3. **用户友好的错误提示**：将技术性的错误信息转换为用户易懂的提示信息

4. **错误日志记录**：记录详细的错误日志，便于问题排查

5. **重试机制**：对于某些临时性错误（如网络波动、503 错误），可以实现自动重试机制

## 5. 错误排查指南

开发人员在排查 API 错误时，可以按照以下步骤进行：

1. **检查请求参数**：确认所有必要参数都已提供，且格式正确

2. **检查认证信息**：确认用户已登录，且访问令牌有效

3. **检查权限**：确认用户有足够的权限执行请求的操作

4. **查看错误信息**：仔细阅读 API 返回的错误信息，了解具体错误原因

5. **检查网络连接**：确认客户端与服务器之间的网络连接正常

6. **查看服务器日志**：如有服务器访问权限，查看服务器日志获取更详细的错误信息

## 6. 错误码映射表

下表提供了常见错误类型与建议处理方式的映射关系：

| 错误类型     | HTTP 状态码 | 建议处理方式           |
| ------------ | ----------- | ---------------------- |
| 参数错误     | 400         | 提示用户修正参数       |
| 认证错误     | 401         | 引导用户登录           |
| 权限错误     | 403         | 提示用户权限不足       |
| 资源不存在   | 404         | 提示用户资源不存在     |
| 业务逻辑错误 | 422         | 根据具体错误信息处理   |
| 服务器错误   | 500         | 提示用户稍后重试       |
| 服务不可用   | 503         | 提示用户服务暂时不可用 |
